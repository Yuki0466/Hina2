<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>商品详情 - 优选商城</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <!-- 头部导航 -->
    <header>
        <nav class="container">
            <a href="index.html" class="logo">优选商城</a>
            <ul class="nav-links">
                <li><a href="index.html">首页</a></li>
                <li><a href="cart.html">购物车</a></li>
                <li><a href="profile.html">用户中心</a></li>
            </ul>
        </nav>
    </header>

    <!-- 主要内容 -->
    <main class="container">
        <div id="loadingState" class="loading">
            <div class="spinner"></div>
            <p>加载商品详情中...</p>
        </div>

        <div id="productContent" style="display: none;">
            <!-- 返回按钮 -->
            <button class="btn btn-secondary" onclick="goBack()" style="margin-bottom: 2rem;">
                ← 返回商品列表
            </button>

            <!-- 商品详情 -->
            <div class="product-detail">
                <div class="product-image-section">
                    <img id="productImage" src="" alt="" class="product-detail-image">
                </div>
                <div class="product-detail-info">
                    <h1 id="productName"></h1>
                    <p class="product-detail-price" id="productPrice"></p>
                    <div class="product-meta">
                        <span class="badge" id="productCategory"></span>
                        <span class="badge stock-badge" id="productStock"></span>
                    </div>
                    <p class="product-detail-description" id="productDescription"></p>
                    
                    <div class="quantity-selector">
                        <label for="quantity">数量：</label>
                        <input type="number" id="quantity" class="quantity-input" value="1" min="1" max="99">
                    </div>

                    <div class="product-actions">
                        <button class="btn btn-primary" onclick="addToCart()" style="margin-right: 1rem;">
                            加入购物车
                        </button>
                        <button class="btn btn-secondary" onclick="buyNow()">
                            立即购买
                        </button>
                    </div>

                    <div class="product-features">
                        <h3>商品特点</h3>
                        <ul>
                            <li>✓ 正品保证</li>
                            <li>✓ 7天无理由退换</li>
                            <li>✓ 极速发货</li>
                            <li>✓ 售后保障</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- 相关商品推荐 -->
            <section class="related-products" style="margin-top: 4rem;">
                <h2>相关推荐</h2>
                <div id="relatedProductsContainer" class="products-grid">
                    <div class="loading">
                        <p>加载推荐商品中...</p>
                    </div>
                </div>
            </section>
        </div>

        <!-- 错误状态 -->
        <div id="errorState" style="display: none;">
            <div class="error">
                <h3>商品不存在</h3>
                <p>抱歉，您访问的商品不存在或已下架。</p>
                <button class="btn btn-primary" onclick="goBack()">返回首页</button>
            </div>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase.js"></script>
    <script src="js/utils.js"></script>
    <script>
        let currentProduct = null;
        let productId = null;

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', async function() {
            await utils.initializePage();
            productId = utils.getUrlParam('id');
            
            if (!productId) {
                showErrorState();
                return;
            }

            await loadProductDetail();
            loadRelatedProducts();
        });

        // 加载商品详情
        async function loadProductDetail() {
            try {
                currentProduct = await window.supabaseService.getProductById(productId);
                
                if (!currentProduct || !currentProduct.is_active) {
                    showErrorState();
                    return;
                }

                displayProductDetail();
                
            } catch (error) {
                console.error('加载商品详情失败:', error);
                showErrorState();
            }
        }

        // 显示商品详情
        function displayProductDetail() {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('productContent').style.display = 'block';

            // 填充商品信息
            document.getElementById('productImage').src = currentProduct.image_url || 'https://images.unsplash.com/photo-1505740420928-5e560c06d30e?w=600';
            document.getElementById('productImage').alt = currentProduct.name;
            document.getElementById('productName').textContent = currentProduct.name;
            document.getElementById('productPrice').textContent = utils.formatPrice(currentProduct.price);
            document.getElementById('productCategory').textContent = currentProduct.category;
            document.getElementById('productStock').textContent = `库存: ${currentProduct.stock_count}`;
            document.getElementById('productDescription').textContent = currentProduct.description || '暂无商品描述';

            // 设置数量输入框的最大值
            document.getElementById('quantity').max = currentProduct.stock_count;

            // 更新页面标题
            document.title = `${currentProduct.name} - 优选商城`;

            // 根据库存状态更新购买按钮
            updatePurchaseButtons();
        }

        // 更新购买按钮状态
        function updatePurchaseButtons() {
            const addToCartBtn = document.querySelector('button[onclick="addToCart()"]');
            const buyNowBtn = document.querySelector('button[onclick="buyNow()"]');
            const quantityInput = document.getElementById('quantity');

            if (currentProduct.stock_count <= 0) {
                addToCartBtn.disabled = true;
                addToCartBtn.textContent = '暂时缺货';
                addToCartBtn.classList.add('btn-disabled');
                
                buyNowBtn.disabled = true;
                buyNowBtn.textContent = '暂时缺货';
                buyNowBtn.classList.add('btn-disabled');
                
                quantityInput.disabled = true;
            } else {
                addToCartBtn.disabled = false;
                addToCartBtn.textContent = '加入购物车';
                addToCartBtn.classList.remove('btn-disabled');
                
                buyNowBtn.disabled = false;
                buyNowBtn.textContent = '立即购买';
                buyNowBtn.classList.remove('btn-disabled');
                
                quantityInput.disabled = false;
            }
        }

        // 添加到购物车
        async function addToCart() {
            if (!currentProduct || currentProduct.stock_count <= 0) {
                utils.showError('商品暂时缺货');
                return;
            }

            const quantity = parseInt(document.getElementById('quantity').value);
            
            if (quantity <= 0 || quantity > currentProduct.stock_count) {
                utils.showError(`请输入有效的数量（1-${currentProduct.stock_count}）`);
                return;
            }

            try {
                await utils.cartUtils.addToCart(currentProduct.id, quantity);
            } catch (error) {
                console.error('添加到购物车失败:', error);
            }
        }

        // 立即购买
        async function buyNow() {
            if (!currentProduct || currentProduct.stock_count <= 0) {
                utils.showError('商品暂时缺货');
                return;
            }

            // 先添加到购物车
            await addToCart();
            
            // 然后跳转到购物车页面
            setTimeout(() => {
                window.location.href = 'cart.html';
            }, 1000);
        }

        // 加载相关商品
        async function loadRelatedProducts() {
            try {
                const products = await window.supabaseService.getProductsByCategory(currentProduct.category);
                
                // 过滤掉当前商品
                const relatedProducts = products.filter(p => p.id !== currentProduct.id).slice(0, 4);
                
                displayRelatedProducts(relatedProducts);
            } catch (error) {
                console.error('加载相关商品失败:', error);
                document.getElementById('relatedProductsContainer').innerHTML = '<p>暂无相关商品</p>';
            }
        }

        // 显示相关商品
        function displayRelatedProducts(products) {
            const container = document.getElementById('relatedProductsContainer');
            
            if (!products || products.length === 0) {
                container.innerHTML = '<p>暂无相关商品</p>';
                return;
            }

            container.innerHTML = products.map(product => `
                <div class="product-card" onclick="viewRelatedProduct('${product.id}')">
                    <img src="${product.image_url || 'https://images.unsplash.com/photo-1505740420928-5e560c06d30e?w=300'}" 
                         alt="${product.name}" 
                         class="product-image"
                         onerror="this.src='https://images.unsplash.com/photo-1505740420928-5e560c06d30e?w=300'">
                    <div class="product-info">
                        <h3 class="product-name">${product.name}</h3>
                        <p class="product-price">${utils.formatPrice(product.price)}</p>
                        <button class="btn btn-primary" onclick="event.stopPropagation(); quickAddRelatedToCart('${product.id}')">
                            加入购物车
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // 查看相关商品
        function viewRelatedProduct(productId) {
            window.location.href = `product.html?id=${productId}`;
        }

        // 快速添加相关商品到购物车
        async function quickAddRelatedToCart(productId) {
            try {
                await utils.cartUtils.addToCart(productId, 1);
            } catch (error) {
                console.error('添加到购物车失败:', error);
            }
        }

        // 显示错误状态
        function showErrorState() {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('errorState').style.display = 'block';
        }

        // 返回上一页
        function goBack() {
            if (document.referrer && document.referrer.includes(window.location.hostname)) {
                window.history.back();
            } else {
                window.location.href = 'index.html';
            }
        }

        // 数量输入验证
        document.addEventListener('DOMContentLoaded', function() {
            const quantityInput = document.getElementById('quantity');
            if (quantityInput) {
                quantityInput.addEventListener('change', function() {
                    let value = parseInt(this.value);
                    const max = parseInt(this.max);
                    const min = parseInt(this.min);
                    
                    if (isNaN(value) || value < min) {
                        this.value = min;
                    } else if (value > max) {
                        this.value = max;
                        utils.showError(`库存仅剩 ${max} 件`);
                    }
                });
            }
        });
    </script>

    <style>
        /* 商品详情页特有样式 */
        .product-image-section {
            position: sticky;
            top: 100px;
            height: fit-content;
        }

        .product-detail-image {
            width: 100%;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.12);
        }

        .product-meta {
            display: flex;
            gap: 1rem;
            margin: 1.5rem 0;
        }

        .badge {
            display: inline-block;
            padding: 0.5rem 1rem;
            background: #ecf0f1;
            color: #2c3e50;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .stock-badge {
            background: #d4edda;
            color: #155724;
        }

        .stock-badge.low-stock {
            background: #fff3cd;
            color: #856404;
        }

        .stock-badge.out-of-stock {
            background: #f8d7da;
            color: #721c24;
        }

        .product-actions {
            margin: 2rem 0;
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .product-features {
            margin-top: 2rem;
            padding: 1.5rem;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .product-features h3 {
            margin-bottom: 1rem;
            color: #333;
        }

        .product-features ul {
            list-style: none;
        }

        .product-features li {
            margin-bottom: 0.5rem;
            color: #555;
        }

        .related-products {
            border-top: 2px solid #eee;
            padding-top: 2rem;
        }

        .related-products h2 {
            margin-bottom: 2rem;
            font-size: 1.8rem;
            color: #333;
        }

        .btn-disabled {
            background: #bdc3c7 !important;
            cursor: not-allowed !important;
            opacity: 0.6 !important;
        }

        .btn-disabled:hover {
            transform: none !important;
            background: #bdc3c7 !important;
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .product-detail {
                grid-template-columns: 1fr;
                gap: 2rem;
            }

            .product-image-section {
                position: static;
            }

            .product-actions {
                flex-direction: column;
            }

            .product-actions .btn {
                width: 100%;
            }

            .product-meta {
                flex-direction: column;
                gap: 0.5rem;
            }
        }
    </style>
</body>
</html>